estail
======

Command line Elasticsearch query tool and tailer

Installation
------------

	npm install git+https://bitbucket.org/MailOnline/estail

or

	npm install -g git+https://bitbucket.org/MailOnline/estail

...you may need root access to install -globally.

Usage
-----

	estail [-qcot] [-h host] [-s sort] [-n num] [-f fields] expr
	
estail connects to a specified Elasticsearch host, and makes queries through the REST interface. It has a simple query parser that allows you to specify ES filters and queries. These are unlikely to be optimal, but they do work and are much easier to get right than building JSON queries by hand. It will output JSON to the console, either pretty or compact, and can return the entire response, or just the data. You can also specify which fields to return and what, if any sort order. The optional "tail mode" modifies the query to select by timestamp and poll the server. 

Options:
The order of options and the expression (if any) are not important. Options with no parameter (q,c,o and t) can be combined.

	-q		Show the query JSON as sent to the server, before any response.
	-c		Show compact, rather than pretty JSON responses.
	-o		Only output the document data, not the full response
	-t		"tail" mode - follow the output by restricting by timestamp and polling the server
	-h		The Elasticsearch REST API URL. Default: "http://localhost:9200/_search"
	-s field,field 	Specify sort order fields (if any). Preceeding a fieldname with '-' specifies descending sort
	-f field,field	Specify response fields. Default is entire document as held in _source
	-n num 	Limit response to 'num' results. Defaults to 10
	
The "expression"
Rather than trying to type complicated nested JSON objects on the command line, estail accepts simple JavaScript-style (i.e. C/Java/C++, etc) expressions. These are parsed into Elasticsearch filters. For example

	my.prop=="Hello" && !(timestamp>10000000)

parses to 

	{"query":{"filtered":{"filter":{"and":[{"query":{"match_phrase":{"my.prop":"Hello"}}},{"not":{"range":{"timestamp":{"gt":10000000}}}}]}}}}

...but is much easier to type!

The supported syntax is a subset of JS expression syntax as applied to Elasticsearch. Currently transformations are:
 - 	Binary operators && || > < >= <= translate to simple boolean and range filters
 -  Binary operators == and != translate to a match_phrase (and 'not' if necessary), essentially because there seems to be no simple, guaranteed string equality ES operator if the analyser is unknown.
 -  Unary ! translates to a simple {not:...}
 -  Unary ~ translates to a nested query filter, so that ~match(field,'value') works as a nested match query
 -  Binary "in" is translates to a terms() filter, so that '["abc","def"] in myfield' is true if any of the array elements are terms in myfield
 -  Function calls map to similarly named sub filters & queries, so that 
	
	abc(def,'ghi') // maps to {abc:{def:'ghi'}}   	
	abc(def) // maps to {abc:def}

Common uses might be:
	
	exists(field,'details')		// True if the document conatains a field called "details", maps to: {"filter":{"exists":{"field":"details"}}}
	term(year,1966)				// True if the field 'year' in the document uses the indexed term 1966. Maps to: {"filter":{"term":{"year":1966}}}
	
Examples
--------
Connection to a server and return all documents that have a field called 'statusCode' with a value greater than 301, and follow the output in compact mode

	estail -h http://logstash-es:9200/logstash-2014.11.26/logstashjson/_search 'statusCode>301' -oct

As above, but show only the offending URLs

	estail -h http://logstash-es:9200/logstash-2014.11.26/logstashjson/_search 'statusCode>301' -f statusCode,uri -oct

Show me the query generated by the given expression:

	estail -h http://logstash-es:9200/logstash-2014.11.26/logstashjson/_search 'statusCode>301' -n 0 -q



		